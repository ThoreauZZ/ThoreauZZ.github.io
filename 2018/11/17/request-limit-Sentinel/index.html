<!DOCTYPE html>
<html lang="zh_CN">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="限流-阿里开源Sentinel"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@zhaozhou2010"/>



  	<meta property="og:title" content="限流-阿里开源Sentinel &middot; 造舟野渡" />
  	<meta property="og:site_name" content="造舟野渡" />
  	<meta property="og:url" content="http://thoreauz.com/2018/11/17/request-limit-Sentinel/" />
    <meta name="generator" content="Hugo 0.99.1" />
    
        
            <meta property="og:image" content="/images/cover.jpg"/>
        
    

    
    <meta property="og:description" content="" />
  	<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2018-11-17T13:48:16Z" />

    
    <meta property="article:tag" content="分布式系统" />
    
    

    <title>限流-阿里开源Sentinel &middot; 造舟野渡</title>

    
    <meta name="description" content="Sentinel作用 Sentinelm，分布式系统的流量防卫兵，可以从多个维度保护应用，广泛用于阿里各个系统，是大促稳定性保障的关键。现已开" />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://thoreauz.com/images/favicon.ico">
	  <link rel="apple-touch-icon" href="http://thoreauz.com/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="http://thoreauz.com/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="http://thoreauz.com/css/nav.css" />

    

    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/atelier-forest-light.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
        
          
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/go.min.js"></script>
          
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/lua.min.js"></script>
          
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/vim.min.js"></script>
          
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/yaml.min.js"></script>
          
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/dockerfile.min.js"></script>
          
        
        <script>hljs.initHighlightingOnLoad();</script>
    

    
      
          <link href="http://thoreauz.com/index.xml" rel="alternate" type="application/rss+xml" title="造舟野渡" />
      
      
    
    
    <meta name="generator" content="Hugo 0.105.0">

    <link rel="canonical" href="http://thoreauz.com/2018/11/17/request-limit-Sentinel/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name":  null ,
        "logo": "http://thoreauz.comDog-b.svg"
    },
    "author": {
        "@type": "Person",
        "name":  null ,
        
        "image": {
            "@type": "ImageObject",
            "url": "http://thoreauz.comDog-b.svg",
            "width": 250,
            "height": 250
        }, 
        
        "url": "http://thoreauz.com",
        "sameAs": [
            
            
             
             
             
             
             
            
        ]
    },
    "headline": "限流-阿里开源Sentinel",
    "name": "限流-阿里开源Sentinel",
    "wordCount":  4457 ,
    "timeRequired": "PT9M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": "http://thoreauz.com/2018/11/17/request-limit-Sentinel/",
    "datePublished": "2018-11-17T13:48Z",
    "dateModified": "2018-11-17T13:48Z",
    
    "keywords": "分布式系统",
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://thoreauz.com/2018/11/17/request-limit-Sentinel/"
    }
}
    </script>
    


    

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-113511621-1', 'auto');
      ga('send', 'pageview');

    </script>
    

    
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
        </script>
    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            
            <li class="nav-opened" role="presentation">
            	<a href="http://thoreauz.com/archives/">归档</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="http://thoreauz.com/tags/">标签</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="http://thoreauz.com/about/">关于</a>
            </li>
        
        
    </ul>

    
    <a class="subscribe-button icon-feed" href='http://thoreauz.com/index.xml'>Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">



<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
       <a class="blog-logo" href="http://thoreauz.com"><img src="http://thoreauz.com/Dog-b.svg" alt="Home" /></a>
      
  
  
      <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
  </nav>
</header>


<main class="content" role="main">


  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">限流-阿里开源Sentinel</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2018-11-17T13:48:16Z">
            2018-11-17
          </time>
        
         
          <span class="post-tag small"><a href="http://thoreauz.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">分布式系统</a></span>
         
        </section>
    </header>

    <section class="post-content">
      <h2 id="sentinel作用">Sentinel作用</h2>
<p>Sentinelm，分布式系统的流量防卫兵，可以从多个维度保护应用，广泛用于阿里各个系统，是大促稳定性保障的关键。现已开源，github地址<a href="https://github.com/alibaba/Sentinel">Sentinel</a>。</p>
<p>最常用的场景就是限流，比方说提供某个http接口的服务，经过压测，我单机qps只能达到500，流量再大就可能导致系统崩溃，从而无法提供服务。参考压测进过，可以对此接口限流500，一旦超过，其他请求就快速失败，从而保证系统正常工作不被压垮。sentinel总结起来主要有以下作用：</p>
<ol>
<li>保护服务提供方不被过于频繁的调用压垮。</li>
<li>保护服务调用方不被不可用的服务拖死。</li>
<li>保护系统不超过负载。</li>
</ol>
<p>Sentinel 的开源生态：
<img src="https://user-images.githubusercontent.com/9434884/46240214-9c72ff80-c3d6-11e8-937a-0cffa1e8dc58.png" alt=""></p>
<blockquote>
<p>图1: 来源：sentinel github wiki</p>
</blockquote>
<!-- raw HTML omitted -->
<h2 id="qps限流示例">qps限流示例</h2>
<p>下文通过一个示例，见<a href="https://github.com/alibaba/Sentinel">github</a>下sentinel-demo/sentinel-demo-basic。其他如spring的整合见spring-cloud-starter-alibaba-sentinel<a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba/blob/master/spring-cloud-alibaba-examples/sentinel-example/sentinel-core-example/readme-zh.md">文档</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RunTask</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>stop<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Entry entry <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 1.获取token，如果不能，将会抛出BlockException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                entry <span style="color:#f92672">=</span> SphU<span style="color:#f92672">.</span><span style="color:#a6e22e">entry</span><span style="color:#f92672">(</span>KEY<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                pass<span style="color:#f92672">.</span><span style="color:#a6e22e">addAndGet</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>BlockException e1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                block<span style="color:#f92672">.</span><span style="color:#a6e22e">incrementAndGet</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// biz exception
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                total<span style="color:#f92672">.</span><span style="color:#a6e22e">incrementAndGet</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>entry <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 2. 退出
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    entry<span style="color:#f92672">.</span><span style="color:#a6e22e">exit</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            Random random2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECONDS</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>random2<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>50<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>上面只是截取了FlowQpsDemo的一段代码，这个示例主要做了几个工作：</p>
<ol>
<li>初始化限流规则,限流20</li>
<li>开启32个线程循环执行RunTask，并把总qps/通过qps/限流qps分表计入3个AtomicInteger</li>
<li>开启一个定时任务，每秒统计一次3个AtomicInteger的值，作为统计数据输出</li>
</ol>
<p>如:</p>
<pre tabindex="0"><code>1541907654105, total:1185, pass:20, block:1165
46 send qps is: 1218
1541907655110, total:1218, pass:21, block:1197
45 send qps is: 1130
1541907656115, total:1130, pass:20, block:1110
44 send qps is: 1177
1541907657119, total:1177, pass:22, block:1155
</code></pre><blockquote>
<p>出现大于20的情况，因为统计线程有误差。那么，sentinel之所以能限流，肯定也统计了qps，有误差么？这个问题以后讨论</p>
</blockquote>
<h2 id="概念名词解释">概念名词解释</h2>
<p><img src="http://thoreauz.com/images/2018-11-13-17-20-08.jpg" alt=""></p>
<blockquote>
<p>图2</p>
</blockquote>
<p>可以理解，上图为一个应用，其中ABCDEF为可以对其授权、限流、降级的入口，在sentinel中也叫<strong>切入点</strong>。比如现在访问C的qps为100，但是有可能A-&gt;C的访问频繁但不是很重要，而B-C次数不多但比较关键。此时我只想对A-&gt;C限流，于是就需要一个链路的概念，途中1、2、3组成3条<strong>链路</strong>，链路上的切入点也叫<strong>树节点</strong>。这些切入点可能处于不同链路如C，于是把用来汇总切入点信息的叫<strong>簇结点</strong>。</p>
<p>示最简单的示例中，sentinel入口代码，定义一个切入口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 为需要保护的资源(概念或者逻辑上)定义一个入口，所有访问资源的请求都需要从此入口申请令牌
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Entry entry <span style="color:#f92672">=</span> SphU<span style="color:#f92672">.</span><span style="color:#a6e22e">entry</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">“</span>自定义资源名<span style="color:#960050;background-color:#1e0010">”</span><span style="color:#f92672">);</span>
</span></span></code></pre></div><p>如果要把节点纳入链路中，需要根据链路限流，需要通过上下文（Context）声明链路入口如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ContextUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">enter</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;entrance1&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;appA&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>Entry nodeA <span style="color:#f92672">=</span> SphU<span style="color:#f92672">.</span><span style="color:#a6e22e">entry</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;nodeA&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>nodeA <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>nodeA<span style="color:#f92672">.</span><span style="color:#a6e22e">exit</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> ContextUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">exit</span><span style="color:#f92672">();</span>
</span></span></code></pre></div><h2 id="原理">原理</h2>
<p>还是从示例FlowQpsDemo，进入<code>entry = SphU.entry(KEY)</code>代码开始分析；</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 为了获取令牌，从此入口进入，通过一些列ProcessorSlot校验限流规则，能通过返回Entry，否则抛BlockException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> Entry <span style="color:#a6e22e">entry</span><span style="color:#f92672">(</span>ResourceWrapper resourceWrapper<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> count<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> BlockException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Context context <span style="color:#f92672">=</span> ContextUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context <span style="color:#66d9ef">instanceof</span> NullContext<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> CtEntry<span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Using default context.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        context <span style="color:#f92672">=</span> MyContextUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">myEnter</span><span style="color:#f92672">(</span>Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">CONTEXT_DEFAULT_NAME</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> resourceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ProcessorSlot<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> chain <span style="color:#f92672">=</span> lookProcessChain<span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Means amount of resources (slot chain) exceeds {@link Constants.MAX_SLOT_CHAIN_SIZE},
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * so no rule checking will be done.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>chain <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> CtEntry<span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Entry e <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CtEntry<span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">,</span> chain<span style="color:#f92672">,</span> context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        chain<span style="color:#f92672">.</span><span style="color:#a6e22e">entry</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> resourceWrapper<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> count<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>BlockException e1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">exit</span><span style="color:#f92672">(</span>count<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> e1<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable e1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// This should not happen, unless there are errors existing in Sentinel internal.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        RecordLog<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Sentinel unexpected exception&#34;</span><span style="color:#f92672">,</span> e1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> e<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ol>
<li>从threadLocal获取Context，没有就使用默认Context</li>
<li>获取处理Slot(ProcessorSlot)</li>
<li>执行Slot的entry方法，校验通过则返回Entry</li>
</ol>
<p>整个设计模式和netty类似：</p>
<table>
<thead>
<tr>
<th>责任链模式</th>
<th>netty</th>
<th>sentinel</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>链</td>
<td>ChannelPipeline</td>
<td>chain</td>
<td></td>
<td></td>
</tr>
<tr>
<td>处理器</td>
<td>ChannelHandler</td>
<td>ProcessorSlot</td>
<td></td>
<td></td>
</tr>
<tr>
<td>上下文,携带元数据</td>
<td>ChannelHandlerContext</td>
<td>Context</td>
<td></td>
<td></td>
</tr>
<tr>
<td>不同</td>
<td>双向链表</td>
<td>单向链表</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>所以下文重点看采用了哪些ProcessorSlot。</p>
<h3 id="processorslot">ProcessorSlot</h3>
<p>先看lookProcessChain是如何创建ProcessorSlotChain。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ProcessorSlot<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">lookProcessChain</span><span style="color:#f92672">(</span>ResourceWrapper resourceWrapper<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 更加资源wrapper从缓存查询
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ProcessorSlotChain chain <span style="color:#f92672">=</span> chainMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>chain <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 缓存不存在，加锁双重检查创建chain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>LOCK<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>            chain <span style="color:#f92672">=</span> chainMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>chain <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>chainMap<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_SLOT_CHAIN_SIZE</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                chain <span style="color:#f92672">=</span> SlotChainProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">newSlotChain</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                Map<span style="color:#f92672">&lt;</span>ResourceWrapper<span style="color:#f92672">,</span> ProcessorSlotChain<span style="color:#f92672">&gt;</span> newMap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;</span>ResourceWrapper<span style="color:#f92672">,</span> ProcessorSlotChain<span style="color:#f92672">&gt;(</span>
</span></span><span style="display:flex;"><span>                    chainMap<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                newMap<span style="color:#f92672">.</span><span style="color:#a6e22e">putAll</span><span style="color:#f92672">(</span>chainMap<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                newMap<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">,</span> chain<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                chainMap <span style="color:#f92672">=</span> newMap<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> chain<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>我们接着看<code>chain = SlotChainProvider.newSlotChain()</code>如何创建chain，跟踪代码发现DefaultSlotChainBuilder这个类，build方法如下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> ProcessorSlotChain <span style="color:#a6e22e">build</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ProcessorSlotChain chain <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DefaultProcessorSlotChain<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    chain<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> NodeSelectorSlot<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    chain<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ClusterBuilderSlot<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    chain<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LogSlot<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    chain<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> StatisticSlot<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    chain<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SystemSlot<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    chain<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> AuthoritySlot<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    chain<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> FlowSlot<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    chain<span style="color:#f92672">.</span><span style="color:#a6e22e">addLast</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> DegradeSlot<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> chain<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>NodeSelectorSlot 负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级；</li>
<li>ClusterBuilderSlot 则用于存储资源的统计信息以及调用者信息，例如该资源的 RT, QPS, thread count 等等，这些信息将用作为多维度限流，降级的依据；</li>
<li>StatisticSlot 则用于记录、统计不同纬度的 runtime 指标监控信息；</li>
<li>FlowSlot 则用于根据预设的限流规则以及前面 slot 统计的状态，来进行流量控制；</li>
<li>AuthoritySlot 则根据配置的黑白名单和调用来源信息，来做黑白名单控制；</li>
<li>DegradeSlot 则通过统计信息以及预设的规则，来做熔断降级；</li>
<li>SystemSlot 则通过系统的状态，例如 load1 等，来控制总的入口流量；</li>
</ul>
<p>总体框架图：
<img src="https://github.com/alibaba/Sentinel/raw/master/doc/image/slots.gif" alt=""></p>
<blockquote>
<p>图3</p>
</blockquote>
<p><img src="https://user-images.githubusercontent.com/9434884/46783631-93324d00-cd5d-11e8-8ad1-a802bcc8f9c9.png" alt=""></p>
<blockquote>
<p>图4: 3/4来源：sentinel github wiki</p>
</blockquote>
<p>下午详细看看几个slot。</p>
<h3 id="nodeselectorslot">NodeSelectorSlot</h3>
<p>从上文可知，NodeSelectorSlot对象是根据resourceWrapper缓存，也就是说，图2中BC节点(资源/入口)分别拥有不同NodeSelectorSlot对象。NodeSelectorSlot缓存了对应节点DefaultNode。</p>
<p>但是，缓存DefaultNode的key不是资源名，因为同一个资源可能处于不同链路，所以，sentinel采用Context的名字来缓存DefaultNode，从而构建不同链路的节点树；</p>
<p>图3中treenode还有一种结构没有画出来：</p>
<pre tabindex="0"><code> *                  machine-root
 *                  /         \
 *                 /           \
 *         EntranceNode1   EntranceNode2
 *               /               \
 *              /                 \
 *      DefaultNode(nodeA)   DefaultNode(nodeA)
 *             |                    |
 *             +- - - - - - - - - - +- - - - - - -&gt; ClusterNode(nodeA);
</code></pre><blockquote>
<p>图5</p>
</blockquote>
<h3 id="clusterbuilderslot">ClusterBuilderSlot</h3>
<p>ClusterBuilderSlot用来创建构建资源的ClusterNode，主要维护资源的运行时统计数据，比如响应时间、qps、线程数、异常等。一个资源有一个clusterNode，但可以有多个defaultNode，如上图5。</p>
<h3 id="statisticslot">StatisticSlot</h3>
<p>StatisticSlot 是 Sentinel 的核心功能插槽之一，用于统计实时的调用数据，维护到NodeSelectorSlot和ClusterBuilderSlot创建的数据结构中：</p>
<ul>
<li>clusterNode：资源唯一标识的 ClusterNode 的 runtime 统计</li>
<li>origin：根据来自不同调用者的统计信息</li>
<li>defaultnode: 根据上下文条目名称和资源 ID 的 runtime 统计</li>
<li>入口的统计</li>
</ul>
<p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">entry</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> ResourceWrapper resourceWrapper<span style="color:#f92672">,</span> DefaultNode node<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> count<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throws</span> Throwable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        fireEntry<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> resourceWrapper<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> count<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 线程+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        node<span style="color:#f92672">.</span><span style="color:#a6e22e">increaseThreadNum</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 通过请求数+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        node<span style="color:#f92672">.</span><span style="color:#a6e22e">addPassRequest</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getCurEntry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getOriginNode</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果origin不为空，也更新数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            context<span style="color:#f92672">.</span><span style="color:#a6e22e">getCurEntry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getOriginNode</span><span style="color:#f92672">().</span><span style="color:#a6e22e">increaseThreadNum</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            context<span style="color:#f92672">.</span><span style="color:#a6e22e">getCurEntry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getOriginNode</span><span style="color:#f92672">().</span><span style="color:#a6e22e">addPassRequest</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> EntryType<span style="color:#f92672">.</span><span style="color:#a6e22e">IN</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// ru入站请求，全局统计
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">increaseThreadNum</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addPassRequest</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ProcessorSlotEntryCallback<span style="color:#f92672">&lt;</span>DefaultNode<span style="color:#f92672">&gt;</span> handler <span style="color:#f92672">:</span> StatisticSlotCallbackRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">getEntryCallbacks</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            handler<span style="color:#f92672">.</span><span style="color:#a6e22e">onPass</span><span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> resourceWrapper<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> count<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>BlockException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">.</span><span style="color:#a6e22e">getCurEntry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setError</span><span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Add block count.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        node<span style="color:#f92672">.</span><span style="color:#a6e22e">increaseBlockQps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getCurEntry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getOriginNode</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            context<span style="color:#f92672">.</span><span style="color:#a6e22e">getCurEntry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getOriginNode</span><span style="color:#f92672">().</span><span style="color:#a6e22e">increaseBlockQps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> EntryType<span style="color:#f92672">.</span><span style="color:#a6e22e">IN</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">increaseBlockQps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ProcessorSlotEntryCallback<span style="color:#f92672">&lt;</span>DefaultNode<span style="color:#f92672">&gt;</span> handler <span style="color:#f92672">:</span> StatisticSlotCallbackRegistry<span style="color:#f92672">.</span><span style="color:#a6e22e">getEntryCallbacks</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            handler<span style="color:#f92672">.</span><span style="color:#a6e22e">onBlocked</span><span style="color:#f92672">(</span>e<span style="color:#f92672">,</span> context<span style="color:#f92672">,</span> resourceWrapper<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> count<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        context<span style="color:#f92672">.</span><span style="color:#a6e22e">getCurEntry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setError</span><span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Should not happen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        node<span style="color:#f92672">.</span><span style="color:#a6e22e">increaseExceptionQps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getCurEntry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getOriginNode</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            context<span style="color:#f92672">.</span><span style="color:#a6e22e">getCurEntry</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getOriginNode</span><span style="color:#f92672">().</span><span style="color:#a6e22e">increaseExceptionQps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> EntryType<span style="color:#f92672">.</span><span style="color:#a6e22e">IN</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">increaseExceptionQps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>我们关注下这两行代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">increaseThreadNum</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>node<span style="color:#f92672">.</span><span style="color:#a6e22e">addPassRequest</span><span style="color:#f92672">();</span>
</span></span></code></pre></div><p>线程数统计比较容器，AtomicInteger保存即可。但是qps怎么统计，毕竟qps是一段时间内的请求数量。
我们找到如下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addPassRequest</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    rollingCounterInSecond<span style="color:#f92672">.</span><span style="color:#a6e22e">addPass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    rollingCounterInMinute<span style="color:#f92672">.</span><span style="color:#a6e22e">addPass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在深入看代码之前，我们先看看，假设统计qps，我们会怎么做。比如用一个AtomicInteger数组保存每一秒的请求，index就是当前秒/60。 统计qps只需要用当前时间计算数组Index，就可以获取qps。比如下图，1时秒10qps,2秒时400qps。
<img src="http://thoreauz.com/images/2018-11-16-20-10-36.jpg" alt=""></p>
<blockquote>
<p>图6</p>
</blockquote>
<p>问题在于：读取qps的时间不是整秒，比如上图，统计时刻2秒500毫秒，此时，获取的qps是100，但其实还有后500毫秒的请求没有统计。如果此时我统计t-1呢，也就是1秒的qps，此刻qps是准确的，但是不及时，第2秒的qps突然暴增，那统计就延迟了一秒。对只用来展示倒是问题不太大，但是对于限流来说，晚1秒可能系统已经挂了。</p>
<p>优化的办法，我们会想，把时间间隔缩小，比如10ms。这样是更准确了，但是就得保存很多数据，并且求qps需要把100个刻度加起来。对资源消耗太大。下面，我们看看sentinel怎么做的。</p>
<p>sentinel使用滑动窗口，数据结构如下：
<img src="http://thoreauz.com/images/2018-11-16-21-10-34.jpg" alt=""></p>
<blockquote>
<p>图7</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WindowWrap</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 一个bucket的长度，单位毫秒
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> windowLengthInMs<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 窗口开始时间，也是毫秒
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> windowStart<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 统计值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> T value<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>sentinel 默认采用windowLengthInMs=500计算qps。也就是说，1秒只有两个窗口。初始化如下方式如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 1. 创建rollingCounterInSecond
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> <span style="color:#66d9ef">volatile</span> Metric rollingCounterInSecond <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayMetric<span style="color:#f92672">(</span>1000 <span style="color:#f92672">/</span> SampleCountProperty<span style="color:#f92672">.</span><span style="color:#a6e22e">SAMPLE_COUNT</span><span style="color:#f92672">,</span>1<span style="color:#960050;background-color:#1e0010">）</span>
</span></span><span style="display:flex;"><span>ArrayMetric<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. ArrayMetric包装了 MetricsLeapArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> MetricsLeapArray data <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MetricsLeapArray<span style="color:#f92672">(</span>500<span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LeapArray</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3 array 所以计算qps  ，sampleCount = 2。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">final</span> AtomicReferenceArray<span style="color:#f92672">&lt;</span>WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&gt;</span> array <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicReferenceArray<span style="color:#f92672">&lt;</span>WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&gt;(</span>sampleCount<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>创建几个bucket，取决于SampleCountProperty.SAMPLE_COUNT设置。还有个rollingCounterInMinute用于存储分钟请求数，buckets长度是1000ms。</p>
<h4 id="累积请求">累积请求</h4>
<p>主要是以下步骤：</p>
<ol>
<li>获取当前窗口(bucket)</li>
<li>bucket的值+1</li>
</ol>
<p>获取当前窗口(bucket)</p>
<ol>
<li>获取当前时间</li>
<li>计算当前时间对应的bucket下标(index)和bucket起始时间。</li>
<li>获取窗口 array.get(index),</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">currentWindow</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> time<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> timeId <span style="color:#f92672">=</span> time <span style="color:#f92672">/</span> windowLengthInMs<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Calculate current index.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> idx <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)(</span>timeId <span style="color:#f92672">%</span> array<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Cut the time to current window start.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    time <span style="color:#f92672">=</span> time <span style="color:#f92672">-</span> time <span style="color:#f92672">%</span> windowLengthInMs<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> old <span style="color:#f92672">=</span> array<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>idx<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>old <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> window <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;(</span>windowLengthInMs<span style="color:#f92672">,</span> time<span style="color:#f92672">,</span> newEmptyBucket<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>array<span style="color:#f92672">.</span><span style="color:#a6e22e">compareAndSet</span><span style="color:#f92672">(</span>idx<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> window<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> window<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">yield</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>time <span style="color:#f92672">==</span> old<span style="color:#f92672">.</span><span style="color:#a6e22e">windowStart</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> old<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>time <span style="color:#f92672">&gt;</span> old<span style="color:#f92672">.</span><span style="color:#a6e22e">windowStart</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>updateLock<span style="color:#f92672">.</span><span style="color:#a6e22e">tryLock</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// if (old is deprecated) then [LOCK] resetTo currentTime.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">return</span> resetWindowTo<span style="color:#f92672">(</span>old<span style="color:#f92672">,</span> time<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    updateLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">yield</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>time <span style="color:#f92672">&lt;</span> old<span style="color:#f92672">.</span><span style="color:#a6e22e">windowStart</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Cannot go through here.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> WindowWrap<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;(</span>windowLengthInMs<span style="color:#f92672">,</span> time<span style="color:#f92672">,</span> newEmptyBucket<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><pre tabindex="0"><code>1. 如果为空就新创建一个，new WindowWrap&lt;T&gt;
2. 如果不为空，且窗口时间对得上，则使用这个窗口
3. 如果时间大于返回窗口的起始时间，说明这个窗口过期，应该加锁重置为新窗口
4. 如果窗口时间小于返回窗口的起始时间，也不能用，也需要新返回一个bucket
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// add pass(LongAdder)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>wrap<span style="color:#f92672">.</span><span style="color:#a6e22e">value</span><span style="color:#f92672">().</span><span style="color:#a6e22e">addPass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MetricBucket<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 使用LongAdder保存数据，高并发下比cas原子操作类性能更好
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> LongAdder pass <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LongAdder<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="获取qps">获取qps</h4>
<p>qps就是通过的请求，统计pass只需要把所有bucket的请求相加，StatisticNode代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">pass</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">.</span><span style="color:#a6e22e">currentWindow</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> pass <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>MetricBucket<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span><span style="color:#a6e22e">values</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>MetricBucket window <span style="color:#f92672">:</span> list<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        pass <span style="color:#f92672">+=</span> window<span style="color:#f92672">.</span><span style="color:#a6e22e">pass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pass<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p>qps统计只用了两个buckets，其实也跟我们最初设计的有一样的问题，如果流量波动加大，还是反应慢，可以适当调整bucket数量，比如10个。</p>
</blockquote>
<h3 id="systemslot">SystemSlot</h3>
<p>按系统负载级别限流。只按照一个切入口qps，可能并不能反映系统负责情况。还可能需要考虑所有线程、qps、rt，load等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">entry</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">,</span> ResourceWrapper resourceWrapper<span style="color:#f92672">,</span> DefaultNode node<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> count<span style="color:#f92672">,</span> Object<span style="color:#f92672">...</span> args<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throws</span> Throwable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    SystemRuleManager<span style="color:#f92672">.</span><span style="color:#a6e22e">checkSystem</span><span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    fireEntry<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> resourceWrapper<span style="color:#f92672">,</span> node<span style="color:#f92672">,</span> count<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkSystem</span><span style="color:#f92672">(</span>ResourceWrapper resourceWrapper<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> BlockException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Ensure the checking switch is on.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>checkSystemStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// for inbound traffic only
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> EntryType<span style="color:#f92672">.</span><span style="color:#a6e22e">IN</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// total qps
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">double</span> currentQps <span style="color:#f92672">=</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span> <span style="color:#f92672">:</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">successQps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentQps <span style="color:#f92672">&gt;</span> qps<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> SystemBlockException<span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;qps&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// total thread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> currentThread <span style="color:#f92672">=</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> 0 <span style="color:#f92672">:</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">curThreadNum</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentThread <span style="color:#f92672">&gt;</span> maxThread<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> SystemBlockException<span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;thread&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> rt <span style="color:#f92672">=</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> 0 <span style="color:#f92672">:</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">avgRt</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>rt <span style="color:#f92672">&gt;</span> maxRt<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> SystemBlockException<span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;rt&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// BBR algorithm.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>highestSystemLoadIsSet <span style="color:#f92672">&amp;&amp;</span> getCurrentSystemAvgLoad<span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> highestSystemLoad<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentThread <span style="color:#f92672">&gt;</span> 1 <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            currentThread <span style="color:#f92672">&gt;</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">maxSuccessQps</span><span style="color:#f92672">()</span> <span style="color:#f92672">*</span> Constants<span style="color:#f92672">.</span><span style="color:#a6e22e">ENTRY_NODE</span><span style="color:#f92672">.</span><span style="color:#a6e22e">minRt</span><span style="color:#f92672">()</span> <span style="color:#f92672">/</span> 1000<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> SystemBlockException<span style="color:#f92672">(</span>resourceWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;load&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>比较好理解，只是多了一个load的实时统计。这里使用一个算法<code>BBR</code> 来实现。</p>
<h2 id="总结">总结</h2>
<p>本文简单介绍sentinel的责任链模式完成限流，并介绍了几个slot。其实还有很多细节可以挖掘。</p>
<hr>
<p>参考:</p>
<ol>
<li><a href="https://github.com/alibaba/Sentinel/wiki/">https://github.com/alibaba/Sentinel/wiki/</a></li>
<li><a href="https://github.com/sentinel-group/sentinel-awesome">https://github.com/sentinel-group/sentinel-awesome</a></li>
</ol>

    </section>
    <section class="post-toc">
      <span>CONTENTS</span>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#sentinel作用">Sentinel作用</a></li>
    <li><a href="#qps限流示例">qps限流示例</a></li>
    <li><a href="#概念名词解释">概念名词解释</a></li>
    <li><a href="#原理">原理</a>
      <ul>
        <li><a href="#processorslot">ProcessorSlot</a></li>
        <li><a href="#nodeselectorslot">NodeSelectorSlot</a></li>
        <li><a href="#clusterbuilderslot">ClusterBuilderSlot</a></li>
        <li><a href="#statisticslot">StatisticSlot</a></li>
        <li><a href="#systemslot">SystemSlot</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
    </section>


  <footer class="post-footer">

    








<figure class="author-image">
    <a class="img" href="http://thoreauz.com" style="background-image: url(/Dog-b.svg)"><span class="hidden">二道涯's Picture</span></a>
</figure>


<section class="author">
  <h4><a href="http://thoreauz.com">二道涯</a></h4>
  
  <p>Read <a href="http://thoreauz.com">more posts</a> by this author.</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Hangzhou, China</span>
    <span class="author-link icon-link"><a href="http://thoreauz.com">http://thoreauz.com</a></span>
  </div>
</section>




    
<section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" style="font-size: 1.4em"
       href="https://twitter.com/share?text=%e9%99%90%e6%b5%81-%e9%98%bf%e9%87%8c%e5%bc%80%e6%ba%90Sentinel&nbsp;-&nbsp;%e9%80%a0%e8%88%9f%e9%87%8e%e6%b8%a1&amp;url=http%3a%2f%2fthoreauz.com%2f2018%2f11%2f17%2frequest-limit-Sentinel%2f"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" style="font-size: 1.4em"
       href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fthoreauz.com%2f2018%2f11%2f17%2frequest-limit-Sentinel%2f"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-pinterest" style="font-size: 1.4em"
       href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fthoreauz.com%2f2018%2f11%2f17%2frequest-limit-Sentinel%2f&amp;description=%e9%99%90%e6%b5%81-%e9%98%bf%e9%87%8c%e5%bc%80%e6%ba%90Sentinel"
       onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <span class="hidden">Pinterest</span>
    </a>
    <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=http%3a%2f%2fthoreauz.com%2f2018%2f11%2f17%2frequest-limit-Sentinel%2f"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>



    
     
        
<div id="gitalk-container"></div>

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: "2b2dad16b1a3987d6f94",
    clientSecret: "1c9113ee087febd62068f33f47c190fc4e38bf48",
    repo: "gitment-comments",
    owner: "ThoreauZZ",
    admin: ["ThoreauZZ"],
    
    id: md5(location.pathname),
    distractionFreeMode: "true"
  });
  gitalk.render("gitalk-container");
</script>

 
    



  </footer>
</article>

</main>


  <aside class="read-next">
  
      <a class="read-next-story" style="no-cover" href="http://thoreauz.com/2018/11/17/request-limit-Sentinel-use/">
          <section class="post">
              <h2>限流-Sentinel使用</h2>
              
          </section>
      </a>
  
  
      <a class="read-next-story prev" style="no-cover" href="http://thoreauz.com/2018/11/04/mac-install-minikube/">
          <section class="post">
              <h2>在mac上安装minikube</h2>
          </section>
      </a>
  
</aside>


    <footer class="site-footer clearfix">
        
        <div class="bsz-counter">
            <span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人次;</span>
            <span id="busuanzi_container_page_pv">本文总阅读量<span id="busuanzi_value_page_pv"></span>次</span>
        </div>
        

        <section class="copyright"><a href="">造舟野渡</a> All rights reserved - 2017</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        

    </footer>

    </div>
    <script type="text/javascript" src="http://thoreauz.com/js/jquery.js"></script>
    <script type="text/javascript" src="http://thoreauz.com/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://thoreauz.com/js/index.js"></script>
    
</body>
</html>

